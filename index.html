<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tarmacq - auth</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body { font-family: 'Inter', sans-serif; }

        /* Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        @keyframes pulse-slow {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.05); opacity: 0.4; }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .animate-float { animation: float 6s ease-in-out infinite; }
        .animate-pulse-slow { animation: pulse-slow 8s ease-in-out infinite; }
        .animate-slide-up { animation: slideUp 0.4s ease-out forwards; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        /* Custom Utilities */
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .input-group:focus-within svg { color: #2563eb; }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 50;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        #toast.error { background-color: #ef4444; }
        #toast.success { background-color: #10b981; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: {
                            50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen w-full flex flex-col md:flex-row bg-white text-slate-800 overflow-x-hidden">

    <div id="config-alert" class="hidden fixed top-0 left-0 w-full bg-red-500 text-white text-center py-2 z-50 text-sm font-medium">
        Setup Required: Please check Supabase keys in the code.
    </div>

    <div class="w-full md:w-1/2 flex flex-col justify-between p-8 md:p-12 lg:p-20 animate-fade-in relative">
        
        <div class="mb-8 flex items-center gap-3">
            <img src="https://www.tarmacq.com/logo.png" alt="tarmacq" class="h-10 w-auto object-contain">
            <span class="text-2xl font-bold tracking-tight text-slate-900">tarmacq</span>
        </div>

        <div id="app-container" class="max-w-md w-full mx-auto relative min-h-[400px]">
            </div>

        <div class="mt-auto pt-8 flex flex-col md:flex-row items-center justify-between text-xs text-slate-400 space-y-2 md:space-y-0">
            <div class="flex space-x-4">
                <a href="https://www.tarmacq.com/terms" class="hover:text-slate-600 transition-colors">Terms</a>
                <a href="https://www.tarmacq.com/pp" class="hover:text-slate-600 transition-colors">Privacy</a>
            </div>
            <button id="lang-btn" class="flex items-center hover:text-slate-600 transition-colors uppercase font-semibold">
                <i data-lucide="globe" class="w-3 h-3 mr-1"></i> <span id="current-lang-display">EN</span>
            </button>
        </div>
    </div>

    <div class="hidden md:flex w-1/2 bg-slate-50 relative overflow-hidden items-center justify-center p-12">
        <div class="absolute top-0 left-0 w-full h-full pointer-events-none">
            <div class="absolute top-[-20%] right-[-10%] w-[800px] h-[800px] bg-purple-300/30 rounded-full blur-[120px] mix-blend-multiply animate-pulse-slow"></div>
            <div class="absolute bottom-[-20%] left-[-10%] w-[600px] h-[600px] bg-blue-300/30 rounded-full blur-[100px] mix-blend-multiply animate-pulse-slow" style="animation-delay: 1s"></div>
            <div class="absolute top-[40%] left-[30%] w-[400px] h-[400px] bg-pink-300/30 rounded-full blur-[80px] mix-blend-multiply animate-pulse-slow" style="animation-delay: 2s"></div>
        </div>

        <div class="relative z-10 text-center max-w-md">
            <h2 class="text-4xl font-bold text-slate-800 mb-6 leading-tight" id="hero-title">
                One account. <br/>
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-brand-600 to-purple-600">Infinite possibilities.</span>
            </h2>
            <p class="text-lg text-slate-500 mb-10" id="hero-sub">
                Access the entire tarmacq ecosystem with a single secure login. 
            </p>

            <div class="w-48 h-48 mx-auto relative">
                <div class="absolute inset-0 bg-gradient-to-tr from-brand-500 to-purple-500 rounded-[2rem] rotate-6 opacity-20 animate-float"></div>
                <div class="absolute inset-0 bg-gradient-to-tr from-brand-600 to-cyan-500 rounded-[2rem] -rotate-6 opacity-20 animate-float" style="animation-delay: 0.5s"></div>
                <div class="absolute inset-2 glass-card rounded-[1.5rem] shadow-2xl flex items-center justify-center border border-white/50 animate-float" style="animation-delay: 1s">
                    <div class="relative">
                        <div class="w-20 h-20 bg-gradient-to-br from-cyan-400 to-brand-600 rounded-2xl shadow-lg flex items-center justify-center text-white">
                            <i data-lucide="hexagon" class="w-10 h-10"></i>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="toast"></div>

    <script>
        // ==========================================
        // 1. CONFIGURATION
        // ==========================================
        const SUPABASE_URL = 'https://ulhwmqhxppuhqtoujmum.supabase.co'; 
        const SUPABASE_ANON_KEY = 'sb_publishable_F0QWv6J1ienKfeJSmHPX8Q_BcSVNQX3';
        const REDIRECT_URL = "https://www.tarmacq.com/dashboard"; 
        // ==========================================

        // --- LANGUAGE SYSTEM ---
        let currentLang = 'en';

        const translations = {
            en: {
                login_title: "Login",
                login_subtitle: "Enter your credentials to access tarmacq.",
                welcome_back: "Welcome back! üëã",
                choose_account: "Choose an account",
                to_continue: "To continue to tarmacq",
                use_another: "Use another account",
                email_placeholder: "Email Address",
                pass_placeholder: "Password",
                full_name: "Full Name",
                sign_in_btn: "Sign In",
                create_account_btn: "Create Account",
                keep_signed_in: "Keep me signed in",
                forgot_pass: "Forgot password?",
                dont_have_acc: "Don't have an account?",
                already_have: "Already have an account?",
                register_link: "Register",
                sign_in_link: "Sign In",
                create_acc_title: "Create Account",
                create_acc_sub: "Join tarmacq today.",
                hero_text: "One account. Infinite possibilities.",
                hero_sub: "Access the entire tarmacq ecosystem with a single secure login.",
                active_session: "Active Session",
                sign_out: "Sign out",
                signed_out_msg: "Successfully signed out"
            },
            es: { // Spanish
                login_title: "Iniciar Sesi√≥n",
                login_subtitle: "Ingrese sus credenciales para acceder.",
                welcome_back: "¬°Bienvenido de nuevo! üëã",
                choose_account: "Elige una cuenta",
                to_continue: "Para continuar en tarmacq",
                use_another: "Usar otra cuenta",
                email_placeholder: "Correo Electr√≥nico",
                pass_placeholder: "Contrase√±a",
                full_name: "Nombre Completo",
                sign_in_btn: "Entrar",
                create_account_btn: "Crear Cuenta",
                keep_signed_in: "Mantener sesi√≥n iniciada",
                forgot_pass: "¬øOlvidaste la contrase√±a?",
                dont_have_acc: "¬øNo tienes cuenta?",
                already_have: "¬øYa tienes cuenta?",
                register_link: "Reg√≠strate",
                sign_in_link: "Entrar",
                create_acc_title: "Crear Cuenta",
                create_acc_sub: "√önete a tarmacq hoy.",
                hero_text: "Una cuenta. Posibilidades infinitas.",
                hero_sub: "Accede a todo el ecosistema con un solo login.",
                active_session: "Sesi√≥n Activa",
                sign_out: "Cerrar sesi√≥n",
                signed_out_msg: "Sesi√≥n cerrada exitosamente"
            },
            fr: { // French
                login_title: "Connexion",
                login_subtitle: "Entrez vos identifiants pour acc√©der.",
                welcome_back: "Bon retour ! üëã",
                choose_account: "Choisir un compte",
                to_continue: "Pour continuer vers tarmacq",
                use_another: "Utiliser un autre compte",
                email_placeholder: "Adresse E-mail",
                pass_placeholder: "Mot de passe",
                full_name: "Nom Complet",
                sign_in_btn: "Se connecter",
                create_account_btn: "Cr√©er un compte",
                keep_signed_in: "Rester connect√©",
                forgot_pass: "Mot de passe oubli√© ?",
                dont_have_acc: "Pas de compte ?",
                already_have: "Vous avez d√©j√† un compte ?",
                register_link: "S'inscrire",
                sign_in_link: "Se connecter",
                create_acc_title: "Cr√©er un compte",
                create_acc_sub: "Rejoignez tarmacq aujourd'hui.",
                hero_text: "Un compte. Des possibilit√©s infinies.",
                hero_sub: "Acc√©dez √† tout l'√©cosyst√®me tarmacq.",
                active_session: "Session Active",
                sign_out: "Se d√©connecter",
                signed_out_msg: "D√©connexion r√©ussie"
            }
        };

        function detectLanguage() {
            const browserLang = navigator.language || navigator.userLanguage; 
            const shortLang = browserLang.split('-')[0]; 
            
            if (translations[shortLang]) {
                currentLang = shortLang;
            } else {
                currentLang = 'en';
            }

            document.getElementById('current-lang-display').innerText = currentLang;
            
            const heroTitle = document.querySelector('#hero-title');
            if(heroTitle) {
                heroTitle.innerHTML = translations[currentLang].hero_text.replace('.', '. <br/>')
                .replace('Infinite possibilities', `<span class="text-transparent bg-clip-text bg-gradient-to-r from-brand-600 to-purple-600">${translations[currentLang].hero_text.split('.')[1]}</span>`);
            }
            const heroSub = document.querySelector('#hero-sub');
            if(heroSub) heroSub.innerText = translations[currentLang].hero_sub;
        }

        function t(key) {
            return translations[currentLang][key] || translations['en'][key] || key;
        }

        // --- APP INITIALIZATION ---
        let supabase;

        function initApp() {
            detectLanguage();

            if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                document.getElementById('config-alert').classList.remove('hidden');
                render('login'); 
                return;
            }
            
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            checkSession();
        }

        async function checkSession() {
            if(!supabase) return;
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                state.activeSession = session;
                const displayName = session.user.user_metadata?.full_name || session.user.email.split('@')[0];
                rememberAccount(session.user.email, displayName);
            } 
            
            loadSavedAccounts();
        }

        // --- STATE MANAGEMENT ---
        const state = {
            view: 'loading',
            savedAccounts: [],
            activeSession: null
        };

        function loadSavedAccounts() {
            const stored = localStorage.getItem('tarmacq_accounts');
            if (stored) {
                state.savedAccounts = JSON.parse(stored);
            } else {
                state.savedAccounts = []; 
            }
            determineInitialView();
        }

        function saveAccounts() {
            localStorage.setItem('tarmacq_accounts', JSON.stringify(state.savedAccounts));
        }

        function rememberAccount(email, name) {
            const exists = state.savedAccounts.find(a => a.email === email);
            if (!exists) {
                const colors = ['bg-blue-500', 'bg-emerald-500', 'bg-purple-500', 'bg-orange-500', 'bg-rose-500', 'bg-cyan-500'];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                
                state.savedAccounts.push({ 
                    email, 
                    name: name || email.split('@')[0], 
                    color: randomColor,
                    lastUsed: new Date().toISOString()
                });
                saveAccounts();
            }
        }

        function determineInitialView() {
            if (state.savedAccounts.length > 0) {
                render('chooser');
            } else {
                render('login');
            }
        }

        // --- VIEW RENDERING ---
        const container = document.getElementById('app-container');

        function render(viewName, payload = {}) {
            state.view = viewName;
            container.innerHTML = '';
            
            setTimeout(() => lucide.createIcons(), 0);

            switch(viewName) {
                case 'chooser':
                    container.innerHTML = getChooserView();
                    break;
                case 'login':
                    container.innerHTML = getLoginView(payload.email);
                    break;
                case 'register':
                    container.innerHTML = getRegisterView();
                    break;
            }
        }

        // --- TEMPLATES ---
        
        function getChooserView() {
            const accountsHtml = state.savedAccounts.map(acc => {
                const isActive = state.activeSession && state.activeSession.user.email === acc.email;
                
                // Note: Changed to div wrapper to allow separate click handlers for the Card vs the Logout button
                return `
                <div class="relative group mb-3">
                    <div onclick="selectAccount('${acc.email}')" class="cursor-pointer w-full flex items-center p-4 border ${isActive ? 'border-green-400 ring-1 ring-green-400 bg-green-50/50' : 'border-slate-200 bg-white'} rounded-xl hover:bg-slate-50 hover:border-blue-200 hover:shadow-sm transition-all text-left relative z-0">
                        
                        <div class="w-10 h-10 rounded-full ${acc.color} flex items-center justify-center text-white font-bold text-sm shadow-sm shrink-0">
                            ${acc.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="ml-4 flex-1 min-w-0 pr-8">
                            <div class="font-semibold text-slate-700 hover:text-slate-900 truncate">${acc.name}</div>
                            <div class="text-sm text-slate-500 truncate">${acc.email}</div>
                        </div>
                        
                        ${!isActive ? `<i data-lucide="arrow-right" class="w-4 h-4 text-slate-300 group-hover:text-blue-500 transform group-hover:translate-x-1 transition-all shrink-0"></i>` : ''}
                    </div>

                    ${isActive ? `
                        <div class="absolute top-[-8px] right-[-5px] z-20">
                            <div class="bg-green-500 text-white text-[10px] px-2 py-0.5 rounded-full shadow-sm font-bold tracking-wide uppercase">${t('active_session')}</div>
                        </div>
                        
                        <button onclick="handleLogout(event)" class="absolute right-4 top-1/2 -translate-y-1/2 z-20 p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors" title="${t('sign_out')}">
                             <i data-lucide="log-out" class="w-5 h-5"></i>
                        </button>
                    ` : ''}
                </div>
            `}).join('');

            return `
                <div class="animate-slide-up">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold mb-2 text-slate-900">${t('choose_account')}</h1>
                        <p class="text-slate-500">${t('to_continue')}</p>
                    </div>
                    <div class="space-y-3">
                        ${accountsHtml}
                        <button onclick="render('login')" class="w-full flex items-center p-4 border border-dashed border-slate-300 rounded-xl hover:bg-slate-50 hover:border-slate-400 transition-all text-left text-slate-600">
                            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400">
                                <i data-lucide="user-plus" class="w-5 h-5"></i>
                            </div>
                            <div class="ml-4 font-medium">${t('use_another')}</div>
                        </button>
                    </div>
                </div>
            `;
        }

        function getLoginView(prefilledEmail = '') {
            const account = state.savedAccounts.find(a => a.email === prefilledEmail);
            const isRecognized = !!account;

            let headerHtml = '';
            if (isRecognized) {
                headerHtml = `
                    <div class="flex flex-col items-center mb-6">
                        <button onclick="render('chooser')" class="w-16 h-16 rounded-full ${account.color} flex items-center justify-center text-white font-bold text-2xl mb-3 hover:ring-4 ring-blue-50 transition-all cursor-pointer shadow-md">
                           ${account.name.charAt(0).toUpperCase()}
                        </button>
                        <h1 class="text-2xl font-bold text-slate-900">${t('welcome_back')}</h1>
                        <button onclick="render('chooser')" class="flex items-center text-sm text-slate-500 mt-1 hover:text-blue-600 group">
                          ${account.email} <i data-lucide="chevron-down" class="w-3 h-3 ml-1 group-hover:rotate-180 transition-transform"></i>
                        </button>
                    </div>
                `;
            } else {
                headerHtml = `
                    <div class="mb-8">
                        <h1 class="text-3xl font-bold mb-2 text-slate-900">${t('login_title')}</h1>
                        <p class="text-slate-500">${t('login_subtitle')}</p>
                    </div>
                `;
            }

            return `
                <div class="animate-slide-up">
                    <div class="text-center">${headerHtml}</div>

                    <form onsubmit="handleLogin(event)" class="space-y-4">
                        ${!isRecognized ? `
                        <div class="relative group input-group">
                            <i data-lucide="mail" class="absolute left-4 top-3.5 w-5 h-5 text-slate-400 transition-colors"></i>
                            <input type="email" id="email" name="email" required placeholder="${t('email_placeholder')}" value="${prefilledEmail}"
                                class="w-full bg-white text-slate-900 pl-12 pr-4 py-3 rounded-xl border border-slate-200 focus:border-brand-600 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all placeholder:text-slate-400">
                        </div>
                        ` : `<input type="hidden" id="email" value="${prefilledEmail}">`}

                        <div class="relative group input-group">
                            <i data-lucide="lock" class="absolute left-4 top-3.5 w-5 h-5 text-slate-400 transition-colors"></i>
                            <input type="password" id="password" required placeholder="${t('pass_placeholder')}"
                                class="w-full bg-white text-slate-900 pl-12 pr-12 py-3 rounded-xl border border-slate-200 focus:border-brand-600 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all placeholder:text-slate-400">
                            <button type="button" onclick="togglePassword('password')" class="absolute right-4 top-3.5 text-slate-400 hover:text-slate-600 focus:outline-none">
                                <i data-lucide="eye" class="w-5 h-5"></i>
                            </button>
                        </div>

                        <button type="submit" id="submit-btn"
                            class="w-full bg-brand-600 hover:bg-brand-900 text-white font-semibold py-3 rounded-xl shadow-lg shadow-blue-600/30 active:scale-[0.98] transition-all flex items-center justify-center">
                            <span>${t('sign_in_btn')}</span>
                            <div id="spinner" class="hidden w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin ml-2"></div>
                        </button>

                        <div class="flex items-center justify-between text-sm mt-4">
                            <label class="flex items-center text-slate-500 cursor-pointer hover:text-slate-700">
                                <input type="checkbox" class="w-4 h-4 rounded border-slate-300 text-brand-600 focus:ring-brand-500 mr-2">
                                ${t('keep_signed_in')}
                            </label>
                            <a href="#" class="text-slate-500 hover:text-brand-600 transition-colors">${t('forgot_pass')}</a>
                        </div>
                    </form>

                    <div class="pt-6 text-center">
                        <p class="text-slate-500 text-sm">
                            ${t('dont_have_acc')} 
                            <button onclick="render('register')" class="text-slate-900 font-semibold hover:underline underline-offset-4">
                                ${t('register_link')}
                            </button>
                        </p>
                    </div>
                </div>
            `;
        }

        function getRegisterView() {
            return `
                <div class="animate-slide-up">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold mb-2 text-slate-900">${t('create_acc_title')}</h1>
                        <p class="text-slate-500">${t('create_acc_sub')}</p>
                    </div>

                    <form onsubmit="handleRegister(event)" class="space-y-4">
                        <div class="relative group input-group">
                            <i data-lucide="user" class="absolute left-4 top-3.5 w-5 h-5 text-slate-400 transition-colors"></i>
                            <input type="text" id="reg-name" required placeholder="${t('full_name')}"
                                class="w-full bg-white text-slate-900 pl-12 pr-4 py-3 rounded-xl border border-slate-200 focus:border-brand-600 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all placeholder:text-slate-400">
                        </div>

                        <div class="relative group input-group">
                            <i data-lucide="mail" class="absolute left-4 top-3.5 w-5 h-5 text-slate-400 transition-colors"></i>
                            <input type="email" id="reg-email" required placeholder="${t('email_placeholder')}"
                                class="w-full bg-white text-slate-900 pl-12 pr-4 py-3 rounded-xl border border-slate-200 focus:border-brand-600 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all placeholder:text-slate-400">
                        </div>

                        <div class="relative group input-group">
                            <i data-lucide="lock" class="absolute left-4 top-3.5 w-5 h-5 text-slate-400 transition-colors"></i>
                            <input type="password" id="reg-password" required placeholder="${t('pass_placeholder')}"
                                class="w-full bg-white text-slate-900 pl-12 pr-12 py-3 rounded-xl border border-slate-200 focus:border-brand-600 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all placeholder:text-slate-400">
                             <button type="button" onclick="togglePassword('reg-password')" class="absolute right-4 top-3.5 text-slate-400 hover:text-slate-600 focus:outline-none">
                                <i data-lucide="eye" class="w-5 h-5"></i>
                            </button>
                        </div>

                        <button type="submit" id="submit-btn"
                            class="w-full bg-brand-600 hover:bg-brand-900 text-white font-semibold py-3 rounded-xl shadow-lg shadow-blue-600/30 active:scale-[0.98] transition-all flex items-center justify-center">
                            <span>${t('create_account_btn')}</span>
                            <div id="spinner" class="hidden w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin ml-2"></div>
                        </button>
                    </form>

                    <div class="pt-4 text-center">
                        <p class="text-slate-500 text-sm">
                            ${t('already_have')} 
                            <button onclick="determineInitialView()" class="text-slate-900 font-semibold hover:underline underline-offset-4">
                                ${t('sign_in_link')}
                            </button>
                        </p>
                    </div>
                </div>
            `;
        }

        // --- ACTIONS & HANDLERS ---

        function selectAccount(email) {
            // CHECK IF THIS ACCOUNT IS THE ACTIVE ONE
            if (state.activeSession && state.activeSession.user.email === email) {
                showToast(t('welcome_back') + " " + state.activeSession.user.email, "success");
                setTimeout(() => {
                    window.location.href = REDIRECT_URL;
                }, 500);
                return;
            }
            // Otherwise, ask for login
            render('login', { email });
        }

        async function handleLogout(e) {
            e.stopPropagation(); // Prevent triggering the "Select Account" click
            
            if(!supabase) return;

            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                // Clear local session state
                state.activeSession = null;
                showToast(t('signed_out_msg'), "success");
                
                // Re-render the view to remove the "Active" badge and logout button
                render('chooser');

            } catch (err) {
                console.error("Logout failed", err);
                showToast("Logout failed", "error");
            }
        }

        function togglePassword(id) {
            const el = document.getElementById(id);
            el.type = el.type === 'password' ? 'text' : 'password';
        }

        // --- CORE AUTH FUNCTIONALITY ---

        async function handleLogin(e) {
            e.preventDefault();
            if(!supabase) {
                showToast("Configuration Error: Supabase keys missing.", "error");
                return;
            }

            setLoading(true);
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                if (error) throw error;

                // SUCCESS
                console.log("Login Successful:", data);
                showToast("Login Successful! Redirecting...", "success");
                
                const displayName = data.user.user_metadata?.full_name || email.split('@')[0];
                rememberAccount(email, displayName);
                
                // >>> REDIRECT LOGIC <<<
                setTimeout(() => {
                    window.location.href = REDIRECT_URL;
                }, 1500); 
                
            } catch (err) {
                console.error("Login Error:", err);
                showToast(err.message || "Invalid credentials", "error");
                setLoading(false);
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            if(!supabase) {
                showToast("Configuration Error", "error");
                return;
            }

            setLoading(true);
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const name = document.getElementById('reg-name').value;

            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: { full_name: name }
                    }
                });

                if (error) throw error;

                console.log("Registration Successful:", data);
                
                if (data.session) {
                    showToast("Account created! Redirecting...", "success");
                    rememberAccount(email, name);
                    setTimeout(() => {
                        window.location.href = REDIRECT_URL;
                    }, 1500);
                } else {
                    showToast("Check your email to confirm your account.", "success");
                    setLoading(false);
                }

            } catch (err) {
                console.error("Registration Error:", err);
                showToast(err.message || "Failed to create account", "error");
                setLoading(false);
            }
        }

        // --- UI UTILS ---

        function setLoading(isLoading) {
            const btn = document.getElementById('submit-btn');
            if(!btn) return;
            
            const spinner = document.getElementById('spinner');
            const span = btn.querySelector('span');

            if (isLoading) {
                btn.disabled = true;
                btn.classList.add('opacity-75', 'cursor-not-allowed');
                if(spinner) spinner.classList.remove('hidden');
                if(span) span.style.display = 'none';
            } else {
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
                if(spinner) spinner.classList.add('hidden');
                if(span) span.style.display = 'block';
            }
        }

        function showToast(message, type = 'success') {
            const x = document.getElementById("toast");
            x.innerText = message;
            x.className = "show " + type;
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        // --- START ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initApp();
        });

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="tarmacq">
    <meta property="og:description" content="tarmacq auth, One account Millions of possibilities.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://auth.tarmacq.com">
    <meta property="og:image" content="https://www.tarmacq.com/Untitled (10).png">
    <meta property="og:site_name" content="tarmacq">
    <title>tarmacq - auth</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://www.tarmacq.com/favicon.ico">

    <style>
        :root {
            --bg-dark: #050511;
            --purple-glow: #5b2fa6;
            --warm-glow: #ffcf96;
            --text-white: #ffffff;
            --text-gray: #a1a1aa;
            --accent-pink: #ec4899;
            --accent-blue: #3b82f6;
        }

        body { 
            font-family: 'SF Pro Display', sans-serif; 
            background-color: var(--bg-dark);
            color: var(--text-white);
            overflow-x: hidden;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: white;
        }
        
        .logo img {
            height: 200px;
            width: auto;
            border-radius: 50%;
        }

        /* --- Background Gradient --- */
        .background-gradient {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background:
                radial-gradient(circle at 10% 10%, rgba(255, 208, 150, 0.4) 0%, rgba(91, 47, 166, 0.1) 40%, transparent 60%),
                radial-gradient(circle at 80% 50%, rgba(76, 29, 149, 0.4) 0%, transparent 60%),
                linear-gradient(135deg, #1e1b4b 0%, #020617 100%);
            filter: blur(20px);
        }

        /* --- Animations --- */
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .animate-slide-up { animation: slideUp 0.5s ease-out forwards; }
        .animate-fade-in { animation: fadeIn 0.6s ease-out forwards; }
        .animate-float { animation: float 6s ease-in-out infinite; }
        
        /* --- Glass Components --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }
        .glass-input:focus {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent-pink);
            outline: none;
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.2);
        }

        /* --- Custom Button Style --- */
        .btn-gradient {
            background: linear-gradient(90deg, #837ffb, #ec4899);
            color: white;
            border: none;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.2);
        }
        .btn-gradient:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(236, 72, 153, 0.4);
        }
        .btn-gradient:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            filter: grayscale(0.5);
        }

        /* --- Orbit Animation --- */
        .orbit-ring {
            position: absolute;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 30px rgba(91, 47, 166, 0.1);
        }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background: rgba(20, 20, 30, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        #toast.error { border-color: #ef4444; color: #fca5a5; }
        #toast.success { border-color: #10b981; color: #6ee7b7; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        slate: { 800: '#1e293b' },
                        gray: { 400: '#a1a1aa' }
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen w-full flex flex-col md:flex-row overflow-x-hidden relative">

    <div class="background-gradient"></div>

    <div id="config-alert" class="hidden fixed top-0 left-0 w-full bg-red-500/90 text-white text-center py-2 z-50 text-sm font-medium backdrop-blur-sm">
        Setup Required: Please check Supabase keys in the code.
    </div>

    <div class="w-full md:w-1/2 flex flex-col justify-between p-8 md:p-12 lg:p-20 animate-fade-in relative z-10">
        
        <a href="https://www.tarmacq.com" class="logo">
            <img src="https://www.tarmacq.com/Untitled%20(12).png" alt="tarmacq">
        </a>

        <div id="app-container" class="max-w-md w-full mx-auto relative min-h-[400px]">
        </div>

        <div class="mt-auto pt-8 flex flex-col md:flex-row items-center justify-between text-xs text-gray-400 space-y-2 md:space-y-0">
            <div class="flex space-x-4">
                <a href="https://www.tarmacq.com/terms" class="hover:text-white transition-colors">Terms</a>
                <a href="https://www.tarmacq.com/pp" class="hover:text-white transition-colors">Privacy</a>
            </div>
            <button id="lang-btn" class="flex items-center hover:text-white transition-colors uppercase font-semibold">
                <i data-lucide="globe" class="w-3 h-3 mr-1"></i> <span id="current-lang-display">EN</span>
            </button>
        </div>
    </div>

    <div class="hidden md:flex w-1/2 relative items-center justify-center p-12 overflow-hidden">
        <div class="absolute w-[600px] h-[600px] opacity-60">
             <div class="orbit-ring w-[300px] h-[300px]"></div>
             <div class="orbit-ring w-[500px] h-[500px]"></div>
        </div>

        <div class="relative z-10 text-center max-w-lg glass-panel p-10 rounded-3xl border border-white/5 shadow-2xl">
            <div class="mb-6 flex justify-center">
                <img src="https://auth.tarmacq.com/distribution/services/ist logo off.png" alt="Profile" class="w-24 h-24 rounded-full border-4 border-[#5b2fa6] shadow-[0_0_30px_rgba(91,47,166,0.6)]">
            </div>
            
            <h2 class="text-4xl font-bold text-white mb-4 leading-tight" id="hero-title">
                Authenticating for ist26 <br/>
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400"></span>
            </h2>
            <p class="text-lg text-gray-400 mb-0" id="hero-sub">
                Access the entire tarmacq ecosystem with a single secure login. 
            </p>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        // ==========================================
        // 1. CONFIGURATION
        // ==========================================
        const SUPABASE_URL = 'https://ulhwmqhxppuhqtoujmum.supabase.co'; 
        const SUPABASE_ANON_KEY = 'sb_publishable_F0QWv6J1ienKfeJSmHPX8Q_BcSVNQX3';
        const REDIRECT_URL = "https://ist.tarmacq.com/"; 
        
        // FIXED: Renamed to avoid collision with global 'supabase' object from the CDN
        let supabaseClient = null;
        // ==========================================

        // --- LANGUAGE SYSTEM ---
        let currentLang = 'en';

        const translations = {
            en: {
                login_title: "Welcome Back",
                login_subtitle: "Enter your credentials to access the universe.",
                welcome_back: "Welcome back! ðŸ‘‹",
                choose_account: "Choose Account",
                to_continue: "To continue to tarmacq",
                use_another: "Use another account",
                email_placeholder: "Email Address",
                pass_placeholder: "Password",
                full_name: "Full Name",
                sign_in_btn: "Sign In",
                create_account_btn: "Create Account",
                keep_signed_in: "Keep me signed in",
                dont_have_acc: "Don't have an account?",
                already_have: "Already have an account?",
                register_link: "Register",
                sign_in_link: "Sign In",
                create_acc_title: "Join the Universe",
                create_acc_sub: "Create your tarmacq identity.",
                hero_text: "Authenticating for ist26.",
                hero_sub: "Access the entire tarmacq ecosystem with a single secure login.",
                active_session: "Active",
                sign_out: "Sign out",
                signed_out_msg: "Successfully signed out",
                verify_title: "Verify Account",
                verify_subtitle: "We sent a code to %s.",
                code_placeholder: "6-Digit Code",
                verify_btn: "Verify Identity",
                resend_code: "Resend Code",
                resend_fail: "Failed to resend code: ",
                resend_success: "Code successfully resent!",
                invalid_code: "Invalid code or verification expired.",
            },
            es: { 
                login_title: "Bienvenido",
                login_subtitle: "Ingrese sus credenciales para acceder.",
                welcome_back: "Â¡Hola de nuevo! ðŸ‘‹",
                choose_account: "Elige una cuenta",
                to_continue: "Para continuar en tarmacq",
                use_another: "Usar otra cuenta",
                email_placeholder: "Correo ElectrÃ³nico",
                pass_placeholder: "ContraseÃ±a",
                full_name: "Nombre Completo",
                sign_in_btn: "Entrar",
                create_account_btn: "Crear Cuenta",
                keep_signed_in: "Mantener sesiÃ³n",
                dont_have_acc: "Â¿No tienes cuenta?",
                already_have: "Â¿Ya tienes cuenta?",
                register_link: "RegÃ­strate",
                sign_in_link: "Entrar",
                create_acc_title: "Ãšnete al Universo",
                create_acc_sub: "Crea tu identidad tarmacq.",
                hero_text: "Authenticating for ist26.",
                hero_sub: "Accede a todo el ecosistema con un solo login.",
                active_session: "Activa",
                sign_out: "Cerrar sesiÃ³n",
                signed_out_msg: "SesiÃ³n cerrada",
                verify_title: "Verificar Cuenta",
                verify_subtitle: "Enviamos un cÃ³digo a %s.",
                code_placeholder: "CÃ³digo de 6 dÃ­gitos",
                verify_btn: "Verificar",
                resend_code: "Reenviar CÃ³digo",
                resend_fail: "Error: ",
                resend_success: "Â¡Enviado!",
                invalid_code: "CÃ³digo no vÃ¡lido.",
            },
            fr: { 
                login_title: "Bon retour",
                login_subtitle: "Entrez vos identifiants pour accÃ©der.",
                welcome_back: "Re-bonjour ! ðŸ‘‹",
                choose_account: "Choisir un compte",
                to_continue: "Pour continuer vers tarmacq",
                use_another: "Autre compte",
                email_placeholder: "Adresse E-mail",
                pass_placeholder: "Mot de passe",
                full_name: "Nom Complet",
                sign_in_btn: "Connexion",
                create_account_btn: "CrÃ©er un compte",
                keep_signed_in: "Rester connectÃ©",
                dont_have_acc: "Pas de compte ?",
                already_have: "Vous avez dÃ©jÃ  un compte ?",
                register_link: "S'inscrire",
                sign_in_link: "Connexion",
                create_acc_title: "Rejoindre l'Univers",
                create_acc_sub: "CrÃ©ez votre identitÃ© tarmacq.",
                hero_text: "Authentification pour ist26.",
                hero_sub: "AccÃ©dez Ã  tout l'Ã©cosystÃ¨me tarmacq.",
                active_session: "Active",
                sign_out: "DÃ©connexion",
                signed_out_msg: "DÃ©connectÃ©",
                verify_title: "VÃ©rification",
                verify_subtitle: "Code envoyÃ© Ã  %s.",
                code_placeholder: "Code Ã  6 chiffres",
                verify_btn: "VÃ©rifier",
                resend_code: "Renvoyer",
                resend_fail: "Ã‰chec : ",
                resend_success: "EnvoyÃ© !",
                invalid_code: "Code non valide.",
            }
        };

        function detectLanguage() {
            const browserLang = navigator.language || navigator.userLanguage; 
            const shortLang = browserLang.split('-')[0]; 
            
            if (translations[shortLang]) {
                currentLang = shortLang;
            } else {
                currentLang = 'en';
            }
            updateLanguageUI();
        }

        function toggleLanguage() {
            const langs = ['en', 'es', 'fr'];
            const currentIndex = langs.indexOf(currentLang);
            const nextIndex = (currentIndex + 1) % langs.length;
            currentLang = langs[nextIndex];
            updateLanguageUI();
            
            // Re-render current view to apply translation
            if(state.view) render(state.view);
        }

        function updateLanguageUI() {
            document.getElementById('current-lang-display').innerText = currentLang.toUpperCase();
            
            const heroTitle = document.querySelector('#hero-title');
            if(heroTitle) {
                const text = translations[currentLang].hero_text;
                const parts = text.split('.');
                // Handle split for infinite possibilities gradient
                if (parts.length > 1) {
                     heroTitle.innerHTML = `${parts[0]}. <br/><span class="text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400">${parts[1]}</span>`;
                } else {
                    heroTitle.innerText = text;
                }
            }
            const heroSub = document.querySelector('#hero-sub');
            if(heroSub) heroSub.innerText = translations[currentLang].hero_sub;
        }

        function t(key, args = []) {
            let str = translations[currentLang][key] || translations['en'][key] || key;
            args.forEach((arg) => {
                str = str.replace(`%s`, arg);
            });
            return str;
        }

        // --- APP INITIALIZATION ---

        function initApp() {
            detectLanguage();
            
            // Attach Language Toggle Listener
            const langBtn = document.getElementById('lang-btn');
            if(langBtn) {
                langBtn.addEventListener('click', toggleLanguage);
            }

            if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                document.getElementById('config-alert').classList.remove('hidden');
                render('login'); 
                return;
            }
            
            // Initialize Supabase Client correctly
            // We use 'supabaseClient' to avoid conflict with 'window.supabase'
            if (window.supabase) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } else {
                console.error("Supabase library not loaded");
                showToast("Error loading Supabase", "error");
                return;
            }
            
            checkSession();
        }

        async function checkSession() {
            if(!supabaseClient) return;

            const { data: { session } } = await supabaseClient.auth.getSession();

            if (session) {
                state.activeSession = session;
                const displayName = session.user.user_metadata?.full_name || session.user.email.split('@')[0];
                rememberAccount(session.user.email, displayName);
            } 
            
            loadSavedAccounts();
        }

        // --- STATE MANAGEMENT ---
        const state = {
            view: 'loading',
            savedAccounts: [],
            activeSession: null
        };

        function loadSavedAccounts() {
            const stored = localStorage.getItem('tarmacq_accounts');
            if (stored) {
                state.savedAccounts = JSON.parse(stored);
            } else {
                state.savedAccounts = []; 
            }
            determineInitialView();
        }

        function saveAccounts() {
            localStorage.setItem('tarmacq_accounts', JSON.stringify(state.savedAccounts));
        }

        function rememberAccount(email, name) {
            // Remove existing entry for this email if present (to update it)
            state.savedAccounts = state.savedAccounts.filter(a => a.email !== email);

            const colors = ['bg-blue-600', 'bg-purple-600', 'bg-pink-600', 'bg-indigo-600'];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            
            state.savedAccounts.unshift({ 
                email, 
                name: name || email.split('@')[0], 
                color: randomColor,
                lastUsed: new Date().toISOString()
            });
            saveAccounts();
        }

        function determineInitialView() {
            if (state.savedAccounts.length > 0) {
                render('chooser');
            } else {
                render('login');
            }
        }

        // --- VIEW RENDERING ---
        const container = document.getElementById('app-container');

        function render(viewName, payload = {}) {
            state.view = viewName;
            container.innerHTML = '';
            
            // Defer icon creation slightly to allow DOM update
            setTimeout(() => lucide.createIcons(), 50);

            switch(viewName) {
                case 'chooser':
                    container.innerHTML = getChooserView();
                    break;
                case 'login':
                    container.innerHTML = getLoginView(payload.email);
                    break;
                case 'register':
                    container.innerHTML = getRegisterView();
                    break;
                case 'verify_code':
                    container.innerHTML = getVerifyCodeView(payload.email);
                    break;
            }
        }

        // --- TEMPLATES ---
        
        function getChooserView() {
            const accountsHtml = state.savedAccounts.map(acc => {
                const isActive = state.activeSession && state.activeSession.user.email === acc.email;
                
                return `
                <div class="relative group mb-3">
                    <div onclick="selectAccount('${acc.email}')" class="cursor-pointer w-full flex items-center p-4 border rounded-xl transition-all text-left relative z-0 glass-input ${isActive ? 'border-pink-500 bg-white/10' : 'hover:bg-white/10'}">
                        
                        <div class="w-10 h-10 rounded-full ${acc.color} flex items-center justify-center text-white font-bold text-sm shadow-lg shrink-0 border border-white/20">
                            ${acc.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="ml-4 flex-1 min-w-0 pr-8">
                            <div class="font-semibold text-white truncate">${acc.name}</div>
                            <div class="text-sm text-gray-400 truncate">${acc.email}</div>
                        </div>
                        
                        ${!isActive ? `<i data-lucide="arrow-right" class="w-4 h-4 text-gray-500 group-hover:text-pink-400 transform group-hover:translate-x-1 transition-all shrink-0"></i>` : ''}
                    </div>

                    ${isActive ? `
                        <div class="absolute top-[-8px] right-[-5px] z-20">
                            <div class="bg-[#ec4899] text-white text-[10px] px-2 py-0.5 rounded-full shadow-lg font-bold tracking-wide uppercase">${t('active_session')}</div>
                        </div>
                        
                        <button onclick="handleLogout(event)" class="absolute right-4 top-1/2 -translate-y-1/2 z-20 p-2 text-gray-400 hover:text-red-400 hover:bg-white/5 rounded-full transition-colors" title="${t('sign_out')}">
                             <i data-lucide="log-out" class="w-5 h-5"></i>
                        </button>
                    ` : ''}
                </div>
            `}).join('');

            return `
                <div class="animate-slide-up">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold mb-2 text-white">${t('choose_account')}</h1>
                        <p class="text-gray-400">${t('to_continue')}</p>
                    </div>
                    <div class="space-y-3">
                        ${accountsHtml}
                        <button onclick="render('login')" class="w-full flex items-center p-4 border border-dashed border-gray-600 rounded-xl hover:bg-white/5 hover:border-gray-400 transition-all text-left text-gray-400 hover:text-white">
                            <div class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-gray-400">
                                <i data-lucide="user-plus" class="w-5 h-5"></i>
                            </div>
                            <div class="ml-4 font-medium">${t('use_another')}</div>
                        </button>
                    </div>
                </div>
            `;
        }

        function getLoginView(prefilledEmail = '') {
            const account = state.savedAccounts.find(a => a.email === prefilledEmail);
            const isRecognized = !!account;

            let headerHtml = '';
            if (isRecognized) {
                headerHtml = `
                    <div class="flex flex-col items-center mb-6">
                        <button onclick="render('chooser')" class="w-20 h-20 rounded-full ${account.color} flex items-center justify-center text-white font-bold text-3xl mb-4 hover:ring-4 ring-white/20 transition-all cursor-pointer shadow-[0_0_20px_rgba(255,255,255,0.2)]">
                           ${account.name.charAt(0).toUpperCase()}
                        </button>
                        <h1 class="text-2xl font-bold text-white">${t('welcome_back')}</h1>
                        <button onclick="render('chooser')" class="flex items-center text-sm text-gray-400 mt-2 hover:text-pink-400 group transition-colors">
                          ${account.email} <i data-lucide="chevron-down" class="w-3 h-3 ml-1 group-hover:rotate-180 transition-transform"></i>
                        </button>
                    </div>
                `;
            } else {
                headerHtml = `
                    <div class="mb-8">
                        <h1 class="text-4xl font-bold mb-3 text-white">${t('login_title')}</h1>
                        <p class="text-gray-400 leading-relaxed">${t('login_subtitle')}</p>
                    </div>
                `;
            }

            return `
                <div class="animate-slide-up">
                    <div class="text-center">${headerHtml}</div>

                    <form onsubmit="handleLogin(event)" class="space-y-5">
                        ${!isRecognized ? `
                        <div class="relative group">
                            <i data-lucide="mail" class="absolute left-4 top-3.5 w-5 h-5 text-gray-500 group-focus-within:text-[#ec4899] transition-colors"></i>
                            <input type="email" id="email" name="email" required placeholder="${t('email_placeholder')}" value="${prefilledEmail}"
                                class="w-full glass-input text-white pl-12 pr-4 py-3 rounded-full placeholder:text-gray-600">
                        </div>
                        ` : `<input type="hidden" id="email" value="${prefilledEmail}">`}

                        <div class="relative group">
                            <i data-lucide="lock" class="absolute left-4 top-3.5 w-5 h-5 text-gray-500 group-focus-within:text-[#ec4899] transition-colors"></i>
                            <input type="password" id="password" required placeholder="${t('pass_placeholder')}"
                                class="w-full glass-input text-white pl-12 pr-12 py-3 rounded-full placeholder:text-gray-600">
                            <button type="button" onclick="togglePassword('password')" class="absolute right-4 top-3.5 text-gray-500 hover:text-white focus:outline-none">
                                <i data-lucide="eye" class="w-5 h-5"></i>
                            </button>
                        </div>

                        <button type="submit" id="submit-btn"
                            class="w-full btn-gradient font-semibold py-3.5 rounded-full flex items-center justify-center text-lg mt-2">
                            <span>${t('sign_in_btn')}</span>
                            <div id="spinner" class="hidden w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin ml-2"></div>
                        </button>

                        <div class="flex items-center justify-between text-sm mt-4 px-2">
                            <label class="flex items-center text-gray-400 cursor-pointer hover:text-white">
                                <input type="checkbox" class="w-4 h-4 rounded border-gray-600 bg-transparent text-pink-500 focus:ring-pink-500 mr-2 accent-pink-500">
                                ${t('keep_signed_in')}
                            </label>
                        </div>
                    </form>

                    <div class="pt-8 text-center">
                        <p class="text-gray-500 text-sm">
                            ${t('dont_have_acc')} 
                            <button onclick="render('register')" class="text-white font-semibold hover:text-[#ec4899] transition-colors ml-1">
                                ${t('register_link')}
                            </button>
                        </p>
                    </div>
                </div>
            `;
        }

        function getRegisterView() {
            return `
                <div class="animate-slide-up">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold mb-2 text-white">${t('create_acc_title')}</h1>
                        <p class="text-gray-400">${t('create_acc_sub')}</p>
                    </div>

                    <form onsubmit="handleRegister(event)" class="space-y-4">
                        <div class="relative group">
                            <i data-lucide="user" class="absolute left-4 top-3.5 w-5 h-5 text-gray-500 group-focus-within:text-[#ec4899] transition-colors"></i>
                            <input type="text" id="reg-name" required placeholder="${t('full_name')}"
                                class="w-full glass-input text-white pl-12 pr-4 py-3 rounded-full placeholder:text-gray-600">
                        </div>

                        <div class="relative group">
                            <i data-lucide="mail" class="absolute left-4 top-3.5 w-5 h-5 text-gray-500 group-focus-within:text-[#ec4899] transition-colors"></i>
                            <input type="email" id="reg-email" required placeholder="${t('email_placeholder')}"
                                class="w-full glass-input text-white pl-12 pr-4 py-3 rounded-full placeholder:text-gray-600">
                        </div>

                        <div class="relative group">
                            <i data-lucide="lock" class="absolute left-4 top-3.5 w-5 h-5 text-gray-500 group-focus-within:text-[#ec4899] transition-colors"></i>
                            <input type="password" id="reg-password" required placeholder="${t('pass_placeholder')}"
                                class="w-full glass-input text-white pl-12 pr-12 py-3 rounded-full placeholder:text-gray-600">
                             <button type="button" onclick="togglePassword('reg-password')" class="absolute right-4 top-3.5 text-gray-500 hover:text-white focus:outline-none">
                                <i data-lucide="eye" class="w-5 h-5"></i>
                            </button>
                        </div>

                        <button type="submit" id="submit-btn"
                            class="w-full btn-gradient font-semibold py-3.5 rounded-full flex items-center justify-center text-lg mt-4">
                            <span>${t('create_account_btn')}</span>
                            <div id="spinner" class="hidden w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin ml-2"></div>
                        </button>
                    </form>

                    <div class="pt-6 text-center">
                        <p class="text-gray-500 text-sm">
                            ${t('already_have')} 
                            <button onclick="determineInitialView()" class="text-white font-semibold hover:text-[#ec4899] transition-colors ml-1">
                                ${t('sign_in_link')}
                            </button>
                        </p>
                    </div>
                </div>
            `;
        }

        function getVerifyCodeView(email) {
            return `
                <div class="animate-slide-up">
                    <div class="text-center mb-8">
                        <div class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4 text-[#ec4899]">
                            <i data-lucide="shield-check" class="w-8 h-8"></i>
                        </div>
                        <h1 class="text-3xl font-bold mb-2 text-white">${t('verify_title')}</h1>
                        <p class="text-gray-400 text-sm max-w-[280px] mx-auto">${t('verify_subtitle', [email])}</p>
                    </div>

                    <form onsubmit="handleCodeVerification(event, '${email}')" class="space-y-6">
                        <div class="relative group">
                            <input type="text" id="verification-code" required placeholder="000000" inputmode="numeric" pattern="[0-9]{6}" maxlength="6"
                                class="w-full glass-input text-white py-4 rounded-full text-center text-3xl font-mono tracking-[0.5em] placeholder:text-gray-700 placeholder:tracking-normal focus:border-[#ec4899]">
                        </div>

                        <button type="submit" id="submit-code-btn"
                            class="w-full btn-gradient font-semibold py-3.5 rounded-full flex items-center justify-center text-lg">
                            <span>${t('verify_btn')}</span>
                            <div id="spinner-code" class="hidden w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin ml-2"></div>
                        </button>
                        
                        <p class="pt-2 text-center text-sm text-gray-500">
                            Didn't receive the code? 
                            <button type="button" onclick="resendCode('${email}')" class="text-[#ec4899] font-semibold hover:underline">
                                ${t('resend_code')}
                            </button>
                        </p>
                    </form>
                </div>
            `;
        }

        // --- ACTIONS & HANDLERS ---

        function selectAccount(email) {
            if (state.activeSession && state.activeSession.user.email === email) {
                showToast(t('welcome_back'), "success");
                setTimeout(() => {
                    window.location.href = REDIRECT_URL;
                }, 500);
                return;
            }
            render('login', { email });
        }

        async function handleLogout(e) {
            e.stopPropagation(); 
            
            if(!supabaseClient) return;

            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                
                state.activeSession = null;
                showToast(t('signed_out_msg'), "success");
                render('chooser');

            } catch (err) {
                console.error("Logout failed", err);
                showToast("Logout failed", "error");
            }
        }

        function togglePassword(id) {
            const el = document.getElementById(id);
            el.type = el.type === 'password' ? 'text' : 'password';
        }

        // --- CORE AUTH FUNCTIONALITY ---

        async function handleLogin(e) {
            e.preventDefault();
            if(!supabaseClient) {
                showToast("Configuration Error: Supabase client not ready.", "error");
                return;
            }

            setLoading(true, 'submit-btn', 'spinner');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                if (error) throw error;

                console.log("Login Successful:", data);
                showToast("Login Successful! Redirecting...", "success");
                
                const displayName = data.user.user_metadata?.full_name || email.split('@')[0];
                rememberAccount(email, displayName);
                
                setTimeout(() => {
                    window.location.href = REDIRECT_URL;
                }, 1500); 
                
            } catch (err) {
                console.error("Login Error:", err);
                showToast(err.message || "Invalid credentials", "error");
                setLoading(false, 'submit-btn', 'spinner');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            if(!supabaseClient) {
                showToast("Configuration Error: Supabase client not ready", "error");
                return;
            }

            setLoading(true, 'submit-btn', 'spinner');
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const name = document.getElementById('reg-name').value;

            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: { full_name: name }
                    }
                });

                if (error) throw error;

                if (data.user && !data.session) {
                    showToast("Registration successful! Check your email.", "success");
                    setLoading(false, 'submit-btn', 'spinner');
                    render('verify_code', { email }); 
                } else if (data.session) {
                    showToast("Account created! Redirecting...", "success");
                    rememberAccount(email, name);
                    setTimeout(() => {
                        window.location.href = REDIRECT_URL;
                    }, 1500);
                }

            } catch (err) {
                console.error("Registration Error:", err);
                showToast(err.message || "Failed to create account", "error");
                setLoading(false, 'submit-btn', 'spinner');
            }
        }

        async function handleCodeVerification(e, email) {
            e.preventDefault();
            if(!supabaseClient) return;

            const code = document.getElementById('verification-code').value;
            setLoading(true, 'submit-code-btn', 'spinner-code');
            
            try {
                const { data, error } = await supabaseClient.auth.verifyOtp({
                    email: email,
                    token: code,
                    type: 'signup', 
                });

                if (error) throw error;

                showToast("Verification successful! Redirecting...", "success");
                
                const displayName = data.user.user_metadata?.full_name || email.split('@')[0];
                rememberAccount(email, displayName); 

                setTimeout(() => {
                    window.location.href = REDIRECT_URL;
                }, 1500);

            } catch (err) {
                console.error("Verification Error:", err);
                showToast(t('invalid_code'), "error");
                setLoading(false, 'submit-code-btn', 'spinner-code');
            }
        }

        async function resendCode(email) {
            showToast("Resending code...", "success");
            const { error } = await supabaseClient.auth.resend({
                type: 'signup',
                email: email,
            });
            
            if (error) {
                showToast(t('resend_fail') + error.message, "error");
            } else {
                showToast(t('resend_success'), "success");
            }
        }

        // --- UI UTILS ---

        function setLoading(isLoading, btnId = 'submit-btn', spinnerId = 'spinner') {
            const btn = document.getElementById(btnId);
            if(!btn) return;
            
            const spinner = document.getElementById(spinnerId);
            const span = btn.querySelector('span');

            if (isLoading) {
                btn.disabled = true;
                if(spinner) spinner.classList.remove('hidden');
                if(span) span.style.display = 'none';
            } else {
                btn.disabled = false;
                if(spinner) spinner.classList.add('hidden');
                if(span) span.style.display = 'block';
            }
        }

        function showToast(message, type = 'success') {
            const x = document.getElementById("toast");
            x.innerText = message;
            x.className = "show " + type;
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        // --- START ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initApp();
        });

    </script>
</body>
</html>
